---
title: "586 Project"
author: "Xinyu Dong"
date: "2023-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Descrption 
The sage thrasher is a medium-sized passerine bird from the family Mimidae, which also includes mockingbirds, tremblers, and New World catbirds. It is the only member of the genus Oreoscoptes. This seems less close to the Caribbean thrashers, but rather to the mockingbirds instead.

The Sage Thrasher is one of the rarest birds in Canada. Prior to 1930, there were 30 or more nesting pairs at up to six sites; in recent years, only 4 - 10 pairs have been seen at one or two sites. Over the past 70 years, there has been an estimated 50 percent loss of habitat for the Sage Thrasher. Heavy grazing and clearing of sagebrush to improve range conditions has seriously affected the availability of suitable nesting areas. The preservation of remaining Sage Thrashers depends on the careful management of remaining large tracts of dense sagebrush habitat. Heavy grazing of sagebrush sites should be avoided, and areas cleared of sagebrush should be restored whenever possible.

The data used in this reports come from `eBirds`. `eBird` is a collective enterprise that takes a novel approach to citizen science by developing cooperative partnerships among experts in a wide range of fields: population ecologists, conservation biologists, quantitative ecologists, statisticians, computer scientists, GIS and informatics specialists, application developers, and data administrators.

## Data Processing 
```{r,message=FALSE}
# Import the Bird Data 
library(readr)
BC_data <- read_csv("BC_data.csv")

BC_data <- BC_data[, colSums(!is.na(BC_data)) > 0]

# Import Covariate data
load("BC_Covariates.Rda")



# Construct ppp data
```


```{r,message=FALSE}
# Load required packages
library(sp)
library(dplyr)
library(sf)
library(spatstat)
library(maptools)

# Read occurrence records from CSV file
df <- read.csv("BC_data.csv", stringsAsFactors = FALSE)



# Convert latitude and longitude to spatial points and transform to BC Albers projection
coord <- df[,c('decimalLatitude','decimalLongitude')]
coord <- na.omit(coord)

#Convert the coordinate
coordinates(coord)<- ~decimalLongitude+decimalLatitude
proj4string(coord) <- CRS("+proj=longlat +datum=WGS84")
coord_conv <- spTransform(coord,CRS("+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs"))


# Read in environmental variables
load("BC_Covariates.Rda")

win = as.owin(DATA$Window)
ppp_birds <- ppp(coord_conv@coords[,1], 
                 coord_conv@coords[,2], 
                 window=win)
```


```{r}
#plot(ppp_birds)

cutted <- cut(DATA$Elevation,
         5,
         labels = c("Low", "Medium-Low", "Medium", "Medium-High", "High"))
plot(cut(DATA$Elevation,
         5,
         labels = c("Low", "Medium-Low", "Medium", "Medium-High", "High")),
     main = "Elevation classes")
     #,ylim=c(369043,800000))
#overlay the park locations
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "white", cex = 0.6)
       #,ylim=c(369043,800000))
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "black", cex = 0.4)
       #,ylim=c(369043,800000))


```

## Variable of Intrest
```{r}
plot(DATA$HFI)
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "white", cex = 0.6)
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "black", cex = 0.4)

```


```{r}
plot(DATA$Dist_Water)
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "white", cex = 0.6)
points(ppp_birds$x, ppp_birds$y, pch = 19, col = "black", cex = 0.4)

```

```{r}
plot(density(data.frame(DATA$Dist_Water)$value), 
     main = "KDE for Oreoscoptes montanus and general BC ", col = 1)

lines(density(DATA$Dist_Water[ppp_birds]), 
      col = 2, 
      lty = 2)


legend("topright", legend = c("Distance from water of montanus", "Distance from water of BC"),
       col = 1:2, lty = 1:2
       )
```

- We can see the the distribution density of Oreoscoptes montanus is highly related to the `The distance to water`. Therefore, we will adopt this variabel as our covariable to
further investigate how the distribution of Oreoscoptes montanus is related to the distance to water.

```{r}
plot(density(data.frame(DATA$Elevation)$value), 
     main = "KDE for Oreoscoptes montanus and general BC ", col = 1)

lines(density(DATA$Elevation[ppp_birds]), 
      col = 2, 
      lty = 2)


legend("topright", legend = c("Elevation from water of BC","Elevation montanus"),
       col = 1:2, lty = 1:2
       )
```


```{r}
plot(density(data.frame(DATA$HFI)$value), 
     main = "KDE for Oreoscoptes montanus and general BC ", col = 1)

lines(density(DATA$HFI[ppp_birds]), 
      col = 2, 
      lty = 2)


legend("topright", legend = c("Elevation from water of BC","Elevation montanus"),
       col = 1:2, lty = 1:2
       )
```



## Distribution Pattern 

### Kernel Likelihoood Estimation(Meaningless)
```{r}
# Kernel density
lambda_u_hat <- density(ppp_birds,sigma = bw.ppl) # Hotspot Analysis
# Visualise kernel
plot(lambda_u_hat,
     main = "Kernel estimate of Park intensity")

#plot(ppp_birds,
#     pch = 16,
#     cex = 0.6,
#     cols = "white",
#     add = T)
#plot(ppp_birds,
#     pch = 16,
#     cex = 0.5,
#     cols = "lightblue",
#     add = T)
```

### Hotspot Analysis
```{r}
# Hotspot Analysis
# Estimate R
R <- bw.ppl(ppp_birds) #Calculate test statistic
LR <- scanLRTS(ppp_birds, r = R)
#Plot the output
plot(LR)
#plot(bc_parks[[2]], add = TRUE)
```

The hopspot for the is in the Osoyoos. 

## Co-variates  check 

### $\rho$ Function 
```{r}

#Extract dis  to water  information
disw <- DATA$Dist_Water #Estimate Rho
rho <- rhohat(ppp_birds, disw)

plot(rho,xlim = c(0, max(DATA$Dist_Water)))



```


For Oreoscoptes montanus, they seems to have a specific preference for habitants in terms of the distance to water. From the graph, there is a narrow bandth. 



```{r}
elev <- DATA$Elevation #Estimate Rho
rho <- rhohat(ppp_birds, elev)

plot(rho,xlim = c(0, max(DATA$Elevation)))
```
For Oreoscoptes montanus, they seems have two clusters: one group living near the 0 elevation, and another group lives in around 500m. 


To conclude, `distance to water` is an good candidate of co-variates, and `elevation` has the potential to be a sedonary covariates. We will use those two in our Regression Analysis. 
`


## Regression 
Now we konw that `distance to water` and `elevation` plays a crucial role if we want to dig out where we could find these birds, which only mean this varible can help us even *predict* where this birds will live, based on theri current habitats.

This is of crucial meaning in identify potential location for re-habitation.  ....




Based on the initial graph, a reasonable form of the model is 


$$
\lambda_{\text {B. occ }}(u)=e^{\beta_0+\beta_1 \text { elevation }(u)+\beta_2 \text { elevation }(u)^2+\beta_3 \operatorname{dist water}(u)+\beta_4 \operatorname{dist water}(u)^2}
$$


```{r}
#Fit the PPP model

library(spatstat)

mu <- mean(DATA$Elevation)
stdev <- sd(DATA$Elevation)
DATA$Elevation_scaled <- eval.im((Elevation - mu)/stdev, DATA)

mu <- mean(DATA$Dist_Water)
stdev <- sd(DATA$Dist_Water)
DATA$Dist_Water_scaled <- eval.im((Dist_Water - mu)/stdev, DATA)

# Fit the model with scaled covariates
fit <- ppm(ppp_birds ~ Elevation_scaled + I(Elevation_scaled^2) + Dist_Water_scaled + I(Dist_Water_scaled^2),
           data = DATA)

# This doesnt coverage, maybe to complicated 
```


```{r}
fit <- ppm(ppp_birds ~ Elevation_scaled + Dist_Water_scaled + I(Dist_Water_scaled^2),
           data = DATA)
# View the model summary



coef(summary(fit))

```



The coefficients are all statistically significant, and suggest that $\lambda(u)$
 can be estimated as:
$$
To .. be ..typed ..
$$


```{r}
#Plot the model predictions
plot(fit,
     se = FALSE,
     superimpose = FALSE)

#Overlay the B. pendula locations
plot(ppp_birds,
     pch = 16,
     cex = 0.7,
     cols = "white",
     add = TRUE)
plot(ppp_birds,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)
```
```{r}
#Mean disw
#E_disw <- mean(DATA$Dist_Water_scaled) # just 0

#Elevational effect on lambda at mean disw
elev_effect <- effectfun(fit, "Elevation_scaled", Dist_Water_scaled = 0, se.fit = T)

disw_effect <- effectfun(fit, "Dist_Water_scaled", Elevation_scaled = 0, se.fit = T)



#Side by side plotting
par(mfrow = c(1,2))

#Plot the elevation effect 

plot(elev_effect,
     legend = FALSE,
     main = "Elevation effect at mean distance to water ")
plot(disw_effect,
     legend = FALSE,
     main = "Distance to Water  effect at mean elevation ")

```



## Model Validation 
### Quadrat counting
```{r}
#Run the quadrat test
quadrat.test(fit, nx = 2, ny = 4)
```
The small p value tells us that there’s a significant deviation from our model’s predictions. Let us dig out how to improve it.


### Partial residual plots
```{r}
#Calculate the partial residuals as a function of elevation
par_res_elev <- parres(fit, "Elevation_scaled")

#Calculate the relative intensity as a function of gradient
par_res_disw <- parres(fit, "Dist_Water_scaled")

#Side by side plotting
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation_scaled")
plot(par_res_disw,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Dist_Water_scaled)")
```

From these figures we can see that the quadratic terms are not capturing the patterns in our data particularly well. As an improvement, we could try adding higher-order polynomials, but polynomials can be unstable. In this situation, it may be worth switching from a linear modelling framework, to an additive modelling framework (i.e., GAMs). 

### GAM Not Valid,still 'df' was too small
```{r}
library(splines)

#Fit the PPP model
fit_smooth <- ppm(ppp_birds ~ bs(Elevation_scaled,2) + bs(Dist_Water_scaled, 3), data = DATA, use.gam = TRUE)

fit_smooth
```
```{r}
#Calculate the partial residuals as a function of elevation
par_res_elev <- parres(fit_smooth, "Elevation_scaled")

#Calculate the relative intensity as a function of gradient
par_res_disw <- parres(fit_smooth, "Dist_Water_scaled")

#Side by side plotting
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation_scaled")
plot(par_res_disw,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Dist_Water_scaled)")
```

```{r}
#Plot the model predictions
plot(fit_smooth,
     se = FALSE,
     superimpose = FALSE)

#Overlay the B. pendula locations
plot(ppp_birds,
     pch = 16,
     cex = 0.7,
     cols = "white",
     add = TRUE)
plot(ppp_birds,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)
```

- For a `GAM`, model, it looks like we do not have enough data to fit.


## Conclusion 
- The partial graph, still does not go well to capture the distribution. 
- The reason is more more the variables selection rather than the model.
- Though `The distance to water` and `elevation` may be explainable in some sense, to accurately fit the location, we may need more co-variate.
- For example, a reasonable guess is the average temperature, as all this species are densely located in the south end of BC. 
- To further improve the fitting, we can incoprate `temperature` to our model 
